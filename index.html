<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paradise Handball League - Player Registration 2025</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom Styles */
        body { font-family: 'Inter', sans-serif; background-color: #f0f4f8; }
        .form-container { max-width: 800px; margin: 2rem auto; background-color: white; border-radius: 12px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); overflow: hidden; }
        .form-header { background: linear-gradient(135deg, #4a90e2, #50e3c2); color: white; padding: 1.5rem 2rem; border-bottom: 1px solid #e5e7eb; text-align: center; }
        .form-header img { max-width: 150px; margin-bottom: 1rem; display: inline-block; }
        .form-step { padding: 2rem; display: none; }
        .form-step.active { display: block; }
        .form-input, .form-select, .form-textarea { width: 100%; padding: 0.75rem 1rem; border: 1px solid #d1d5db; border-radius: 8px; margin-top: 0.25rem; transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: #4a90e2; box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.2); }
        .form-label { display: block; font-weight: 600; margin-bottom: 0.25rem; color: #374151; }
        .btn { padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 600; cursor: pointer; transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out; display: inline-flex; align-items: center; justify-content: center; text-align: center; }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background-color: #4a90e2; color: white; border: none; }
        .btn-primary:hover { background-color: #357abd; }
        .btn-secondary { background-color: #e5e7eb; color: #374151; border: 1px solid #d1d5db; }
        .btn-secondary:hover { background-color: #d1d5db; }
        .button-group { display: flex; justify-content: space-between; margin-top: 1.5rem; }
        .error-message { color: #ef4444; font-size: 0.875rem; margin-top: 0.25rem; min-height: 1.25rem; /* Reserve space */ }
        .terms-section { background-color: #f9fafb; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem; border: 1px solid #e5e7eb; }
        .terms-section h3 { font-size: 1.1rem; font-weight: 600; margin-bottom: 0.75rem; color: #1f2937; }
        .terms-section ul { list-style-type: decimal; margin-left: 1.5rem; color: #4b5563; }
        .terms-section li { margin-bottom: 0.5rem; }
        .contact-info { margin-top: 1rem; font-size: 0.9rem; color: #4b5563; }
        /* Responsive Design */
        @media (max-width: 768px) { .form-container { margin: 1rem; } .form-step { padding: 1.5rem; } .button-group { flex-direction: column; gap: 0.5rem; } .button-group .btn { width: 100%; } }
        @media (max-width: 480px) { .form-header { padding: 1rem 1.5rem; } .form-header h1 { font-size: 1.25rem; } .form-step { padding: 1rem; } }
    </style>
</head>
<body>
    <div class="form-container">
        <div class="form-header">
             <img src="https://i.ibb.co/d0hJqjHW/Whats-App-Image-2025-05-05-at-4-56-40-PM.jpg" alt="Paradise Handball League Logo" class="rounded">
            <h1 class="text-2xl font-bold">Paradise Handball League – Player Registration 2025</h1>
            <p class="mt-2 text-sm opacity-90">Welcome! Please read the terms and proceed to registration.</p>
        </div>

        <form id="registrationForm" enctype="multipart/form-data" novalidate>
            <div id="step-1" class="form-step active">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">Player Registration Information</h2>
                <p class="mb-4 text-gray-600">
                    This form is for players who wish to enter the bidding process for team selection in the Paradise Handball League 2025.
                    Please fill out the registration form carefully with accurate and complete information.
                </p>
                <div class="terms-section">
                    <h3>Important Notes & Terms:</h3>
                    <ul>
                        <li>All fields in the registration form are compulsory unless marked optional.</li>
                        <li>Registration requires a payment of ₹100 via Razorpay after form submission.</li>
                        <li>Registration will only be confirmed after successful online payment.</li>
                        <li>Forms without payment confirmation will be rejected.</li>
                        <li>Payment is non-refundable under any circumstances.</li>
                        <li>If a player is not selected by any team owner during the bidding process, the ₹100 registration fee will still not be refunded.</li>
                        <li>Last date for player registration is <strong id="registrationEndDateText">10th May 2025</strong>. No entries will be accepted after this deadline.</li>
                        <li>This form is specifically for the player bidding process in Paradise Handball League 2025.</li>
                    </ul>
                    <div class="contact-info mt-4">
                        <strong>For Any Clarifications, Contact:</strong><br>
                        9797219983 | 9596251338 | 7006453652
                    </div>
                </div>

                <div id="registrationClosedMessage" class="hidden p-4 mb-4 text-sm text-red-700 bg-red-100 rounded-lg" role="alert">
                    <span class="font-medium">Registration Closed!</span> The registration deadline (<span id="deadlineDateText">10th May 2025</span>) has passed. New registrations are no longer accepted.
                </div>

                <div class="button-group justify-end">
                    <button type="button" id="nextButtonStep1" class="btn btn-primary">Proceed to Registration</button>
                </div>
            </div>

            <div id="step-2" class="form-step">
                <h2 class="text-xl font-semibold mb-6 text-gray-800">Player Details</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4"> <div>
                        <label for="email" class="form-label">Email <span class="text-red-500">*</span></label>
                        <input type="email" id="email" name="email" class="form-input" required>
                        <p class="error-message" id="error-email"></p>
                    </div>
                    <div>
                        <label for="name" class="form-label">Name (As per document) <span class="text-red-500">*</span></label>
                        <input type="text" id="name" name="name" class="form-input" required>
                         <p class="error-message" id="error-name"></p>
                    </div>
                    <div>
                        <label for="father_name" class="form-label">Father's Name <span class="text-red-500">*</span></label>
                        <input type="text" id="father_name" name="father_name" class="form-input" required>
                         <p class="error-message" id="error-father_name"></p>
                    </div>
                    <div>
                        <label for="mother_name" class="form-label">Mother's Name <span class="text-red-500">*</span></label>
                        <input type="text" id="mother_name" name="mother_name" class="form-input" required>
                         <p class="error-message" id="error-mother_name"></p>
                    </div>
                    <div>
                        <label for="dob" class="form-label">Date of Birth (DOB) <span class="text-red-500">*</span></label>
                        <input type="date" id="dob" name="dob" class="form-input" required> <p class="error-message" id="error-dob"></p>
                    </div>
                    <div>
                        <label for="phone" class="form-label">Phone Number / WhatsApp <span class="text-red-500">*</span></label>
                        <input type="tel" id="phone" name="phone" class="form-input" pattern="[6-9][0-9]{9}" title="Please enter a valid 10-digit Indian mobile number" required>
                        <p class="error-message" id="error-phone"></p>
                    </div>
                    <div>
                        <label for="gender" class="form-label">Gender <span class="text-red-500">*</span></label>
                        <select id="gender" name="gender" class="form-select" required>
                            <option value="" disabled selected>Select Gender</option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                            <option value="Other">Other</option>
                        </select>
                         <p class="error-message" id="error-gender"></p>
                    </div>
                    <div>
                        <label for="district" class="form-label">District <span class="text-red-500">*</span></label>
                        <input type="text" id="district" name="district" class="form-input" required>
                         <p class="error-message" id="error-district"></p>
                    </div>
                    <div class="md:col-span-2">
                        <label for="aadhaar" class="form-label">Aadhaar Number <span class="text-red-500">*</span></label>
                        <input type="text" id="aadhaar" name="aadhaar" class="form-input" inputmode="numeric" pattern="\d{12}" title="Please enter a valid 12-digit Aadhaar number" required> <p class="error-message" id="error-aadhaar"></p>
                    </div>

                    <div class="md:col-span-2 mt-4">
                        <h3 class="text-lg font-semibold mb-2 text-gray-700">Achievements</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                            <div>
                                <label for="district_achievements" class="form-label">District <span class="text-red-500">*</span></label>
                                <input type="text" id="district_achievements" name="district_achievements" class="form-input" placeholder="e.g., Gold Medal 2024" required>
                                 <p class="error-message" id="error-district_achievements"></p>
                            </div>
                            <div>
                                <label for="state_achievements" class="form-label">State <span class="text-red-500">*</span></label>
                                <input type="text" id="state_achievements" name="state_achievements" class="form-input" placeholder="e.g., Participation 2023" required>
                                 <p class="error-message" id="error-state_achievements"></p>
                            </div>
                            <div>
                                <label for="national_achievements" class="form-label">National <span class="text-red-500">*</span></label>
                                <input type="text" id="national_achievements" name="national_achievements" class="form-input" placeholder="e.g., Bronze Medal 2022" required>
                                 <p class="error-message" id="error-national_achievements"></p>
                            </div>
                        </div>
                    </div>

                     <div>
                        <label for="player_position" class="form-label">Player Position <span class="text-red-500">*</span></label>
                        <input type="text" id="player_position" name="player_position" class="form-input" placeholder="e.g., Goalkeeper, Left Wing" required>
                         <p class="error-message" id="error-player_position"></p>
                    </div>

                    <div>
                        <label for="basic_price" class="form-label">Basic Price (₹50 - ₹200) <span class="text-red-500">*</span></label>
                        <input type="number" id="basic_price" name="basic_price" class="form-input" min="50" max="200" step="10" placeholder="e.g., 100" required>
                         <p class="error-message" id="error-basic_price"></p>
                    </div>

                    <div class="md:col-span-2">
                        <label for="passport_photo" class="form-label">Passport-size Photo <span class="text-red-500">*</span></label>
                        <input type="file" id="passport_photo" name="passport_photo" class="form-input file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" accept="image/jpeg, image/png, image/jpg" required>
                        <p class="text-xs text-gray-500 mt-1">Accepted formats: JPG, PNG, JPEG. Max size: 2MB.</p>
                         <p class="error-message" id="error-passport_photo"></p>
                    </div>
                </div>

                <div class="button-group mt-8"> <button type="button" id="prevButtonStep2" class="btn btn-secondary">Back</button>
                    <button type="button" id="submitAndPayButton" class="btn btn-primary">Submit & Proceed to Pay ₹100</button>
                </div>
                 <div id="formErrorMessage" class="mt-4 text-center text-red-600 font-medium hidden">
                    Please fix the errors above before proceeding.
                </div>
            </div>

            <div id="step-3" class="form-step text-center">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">Processing Payment...</h2>
                <div id="paymentSpinner" class="flex justify-center items-center my-8">
                     <svg class="animate-spin h-10 w-10 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </div>
                <p id="paymentStatusMessage" class="text-gray-600">Please wait while we prepare your payment request.</p>
                 <p id="paymentErrorMessage" class="text-red-600 font-medium mt-4 hidden"></p>
                <button type="button" id="cancelPaymentButton" class="btn btn-secondary mt-6 hidden">Cancel and Edit Form</button>
            </div>

             <div id="step-4" class="form-step text-center">
                 <svg class="w-16 h-16 text-green-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                <h2 class="text-2xl font-semibold mb-3 text-green-700">Registration Successful!</h2>
                <p class="text-gray-700 mb-2">Thank you for registering for the Paradise Handball League 2025!</p>
                <p class="text-gray-600 mb-4">Your registration details and payment confirmation have been received. Admin has been notified.</p>
                <p class="text-gray-600 text-sm">Payment ID: <span id="successPaymentId" class="font-mono"></span></p>
                 <p class="text-gray-600 text-sm">Order ID: <span id="successOrderId" class="font-mono"></span></p>
                 <div class="mt-6">
                     <a href="index.html" class="text-blue-600 hover:underline">Register another player?</a> </div>
            </div>

             <div id="step-5" class="form-step text-center">
                 <svg class="w-16 h-16 text-red-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                <h2 class="text-2xl font-semibold mb-3 text-red-700">Registration Failed</h2>
                <p id="failureReason" class="text-gray-700 mb-4">Unfortunately, we couldn't complete your registration.</p>
                <p class="text-gray-600 mb-6">This could be due to a payment issue or a technical problem. Please try again.</p>
                 <div class="button-group justify-center">
                    <button type="button" id="retryButton" class="btn btn-primary">Retry Registration</button>
                 </div>
                 <p class="text-gray-500 text-sm mt-4">If the problem persists, please contact support using the numbers on the first page.</p>
            </div>

        </form>
    </div>

    <script>
        // --- Configuration ---
        const REGISTRATION_END_DATE_STR = "2025-05-10T23:59:59"; // YYYY-MM-DDTHH:MM:SS
        const REGISTRATION_FEE = 100; // Amount in INR
        const CURRENCY = "INR";
        // ============================================================
        // Razorpay Key ID (Test or Live)
        // ============================================================
        const RAZORPAY_KEY_ID = "rzp_test_s8NLbkJf0TGPMy"; // Your Test Key ID
        // ============================================================
        // FULL URL of your register.php script on the PHP host
        // ============================================================
        const BACKEND_URL = "http://paradise-handball-league.infy.uk/register.php"; // Updated URL
        // ============================================================
        const COMPANY_NAME = "Paradise Handball League";
        const COMPANY_LOGO_URL = "https://i.ibb.co/d0hJqjHW/Whats-App-Image-2025-05-05-at-4-56-40-PM.jpg"; // Your logo URL

        // --- DOM Elements ---
        const form = document.getElementById('registrationForm');
        const steps = Array.from(document.querySelectorAll('.form-step'));
        const nextButtonStep1 = document.getElementById('nextButtonStep1');
        const prevButtonStep2 = document.getElementById('prevButtonStep2');
        const submitAndPayButton = document.getElementById('submitAndPayButton');
        const cancelPaymentButton = document.getElementById('cancelPaymentButton');
        const retryButton = document.getElementById('retryButton');
        const registrationClosedMessage = document.getElementById('registrationClosedMessage');
        const formErrorMessage = document.getElementById('formErrorMessage');
        const paymentStatusMessage = document.getElementById('paymentStatusMessage');
        const paymentErrorMessage = document.getElementById('paymentErrorMessage');
        const paymentSpinner = document.getElementById('paymentSpinner');
        const successPaymentId = document.getElementById('successPaymentId');
        const successOrderId = document.getElementById('successOrderId');
        const failureReason = document.getElementById('failureReason');
        const dobInput = document.getElementById('dob');

        // Input fields for validation
        const inputs = form.querySelectorAll('input[required], select[required], textarea[required]');

        // --- State ---
        let currentStep = 1;
        let registrationOpen = true;
        let razorpayOrderId = null; // To store the order ID from backend

        // --- Functions ---

        // Function to navigate between steps
        function goToStep(stepNumber) {
            steps.forEach((step, index) => {
                step.classList.toggle('active', index + 1 === stepNumber);
            });
            currentStep = stepNumber;
            window.scrollTo(0, 0); // Scroll to top on step change
        }

        // Function to check if registration is open
        function checkRegistrationDeadline() {
            const now = new Date();
            const endDate = new Date(REGISTRATION_END_DATE_STR);
            endDate.setHours(23, 59, 59, 999); // Include the full day

            const endDateText = endDate.toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' });

            document.getElementById('registrationEndDateText').textContent = endDateText;
            document.getElementById('deadlineDateText').textContent = endDateText;

            if (now > endDate) {
                registrationOpen = false;
                registrationClosedMessage.classList.remove('hidden');
                nextButtonStep1.disabled = true;
                nextButtonStep1.classList.add('opacity-50', 'cursor-not-allowed');
                 submitAndPayButton.disabled = true;
                 submitAndPayButton.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                registrationOpen = true;
                registrationClosedMessage.classList.add('hidden');
                nextButtonStep1.disabled = false;
                 nextButtonStep1.classList.remove('opacity-50', 'cursor-not-allowed');
                 submitAndPayButton.disabled = false;
                 submitAndPayButton.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        // Client-Side Validation
        function validateInput(input) {
            const errorElement = document.getElementById(`error-${input.name}`);
            let isValid = true;
            let errorMessage = '';
            const value = input.type === 'file' ? input.value : input.value.trim();

            if (input.required && (input.type === 'file' ? input.files.length === 0 : value === '')) {
                isValid = false; errorMessage = 'This field is required.';
            } else if (input.type === 'email' && value !== '' && !/^\S+@\S+\.\S+$/.test(value)) {
                 isValid = false; errorMessage = 'Please enter a valid email address.';
            } else if (input.type === 'tel' && input.pattern && value !== '' && !new RegExp(input.pattern).test(value)) {
                 isValid = false; errorMessage = input.title || 'Please enter a valid phone number.';
            } else if (input.name === 'aadhaar' && input.pattern && value !== '' && !new RegExp(input.pattern).test(value)) {
                 isValid = false; errorMessage = input.title || 'Please enter a valid 12-digit Aadhaar number.';
            } else if (input.name === 'basic_price' && value !== '') {
                const price = parseFloat(value);
                 // Check range and steps of 10
                if (isNaN(price) || price < 50 || price > 200 || (price % 10 !== 0)) {
                     isValid = false; errorMessage = 'Price must be between ₹50 and ₹200 (in steps of 10).';
                }
            } else if (input.type === 'file' && input.files.length > 0) {
                const file = input.files[0];
                const allowedTypes = ['image/jpeg', 'image/png', 'image/jpg'];
                const maxSize = 2 * 1024 * 1024; // 2MB
                if (!allowedTypes.includes(file.type)) { isValid = false; errorMessage = 'Invalid file type. Only JPG, PNG, JPEG allowed.'; }
                else if (file.size > maxSize) { isValid = false; errorMessage = 'File size exceeds 2MB limit.'; }
            } else if (input.type === 'date' && value !== '') {
                try {
                    const dobDate = new Date(value);
                    const today = new Date(); today.setHours(0,0,0,0);
                    if (isNaN(dobDate.getTime()) || dobDate >= today) { isValid = false; errorMessage = 'Date of Birth must be a valid date in the past.'; }
                } catch (e) { isValid = false; errorMessage = 'Invalid Date of Birth format.'; }
            }

            if (errorElement) {
                errorElement.textContent = errorMessage;
                input.classList.toggle('border-red-500', !isValid && errorMessage !== '');
                input.classList.toggle('border-d1d5db', isValid || errorMessage === '');
            }
            return isValid;
        }

        // Validate all fields in Step 2
        function validateStep2() {
            let isStepValid = true;
            formErrorMessage.classList.add('hidden');
            inputs.forEach(input => {
                if (document.getElementById('step-2').contains(input)) { if (!validateInput(input)) isStepValid = false; }
            });
             if (!isStepValid) {
                formErrorMessage.classList.remove('hidden');
                 const firstErrorField = form.querySelector('#step-2 .border-red-500');
                 if (firstErrorField) { firstErrorField.scrollIntoView({ behavior: 'smooth', block: 'center' }); firstErrorField.focus({ preventScroll: true }); }
            }
            return isStepValid;
        }

        // Initiate Payment Process
        async function initiatePayment() {
            // Final check for placeholder URL
            if (BACKEND_URL === "YOUR_PHP_BACKEND_URL_HERE") {
                 alert("Configuration Error: Backend URL is not set. Please contact the administrator.");
                 return;
            }
            if (!validateStep2()) { console.error("Form validation failed."); return; }

            submitAndPayButton.disabled = true;
            submitAndPayButton.innerHTML = `<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Processing...`;
            submitAndPayButton.classList.add('opacity-75', 'cursor-wait');

            goToStep(3);
            paymentStatusMessage.textContent = 'Validating details and creating payment order...';
            paymentErrorMessage.classList.add('hidden');
            paymentSpinner.classList.remove('hidden');
            cancelPaymentButton.classList.add('hidden');

            const formData = new FormData(form);
            formData.append('action', 'create_order');
            formData.append('amount', REGISTRATION_FEE * 100);
            formData.append('currency', CURRENCY);

            try {
                const response = await fetch(BACKEND_URL, { method: 'POST', body: formData });

                if (!response.ok) {
                     let errorText = `HTTP error! Status: ${response.status} ${response.statusText}`;
                     try { const errorData = await response.json(); errorText = errorData.message || JSON.stringify(errorData); }
                     catch (e) { try { errorText = await response.text(); } catch (e) {} }
                     throw new Error(errorText);
                }

                const contentType = response.headers.get("content-type");
                if (!contentType || !contentType.includes("application/json")) {
                    const responseText = await response.text();
                    console.error("Received non-JSON response:", responseText);
                    throw new Error(`Received non-JSON response from server. Check PHP script output/errors. Response: ${responseText.substring(0, 200)}...`);
                }

                const result = await response.json();

                if (result.success && result.order_id) {
                    razorpayOrderId = result.order_id;
                    paymentStatusMessage.textContent = 'Redirecting to secure payment gateway...';
                    const options = {
                        key: RAZORPAY_KEY_ID, amount: result.amount, currency: result.currency, name: COMPANY_NAME,
                        description: "Player Registration Fee", image: COMPANY_LOGO_URL, order_id: result.order_id,
                        handler: paymentVerificationHandler,
                        prefill: { name: document.getElementById('name').value, email: document.getElementById('email').value, contact: document.getElementById('phone').value },
                        notes: { address: `District: ${document.getElementById('district').value}`, player_name: document.getElementById('name').value },
                        theme: { color: "#4a90e2" }, modal: { ondismiss: handleRazorpayDismiss }
                    };
                    const rzp = new Razorpay(options);
                    rzp.on('payment.failed', handleRazorpayFailure);
                    rzp.open();
                } else {
                    throw new Error(result.message || 'Failed to create Razorpay order. Backend reported an issue.');
                }
            } catch (error) {
                console.error("Error during initiatePayment:", error);
                 paymentStatusMessage.textContent = 'Error Initiating Payment';
                 paymentErrorMessage.textContent = error.message || 'Could not connect to the server or process the request. Check internet and try again. Contact support if persistent.';
                 paymentErrorMessage.classList.remove('hidden');
                 paymentSpinner.classList.add('hidden');
                 cancelPaymentButton.textContent = 'Edit Form Details';
                 cancelPaymentButton.classList.remove('hidden');
                 submitAndPayButton.disabled = false;
                 submitAndPayButton.innerHTML = 'Submit & Proceed to Pay ₹100';
                 submitAndPayButton.classList.remove('opacity-75', 'cursor-wait');
            }
        }

        // Handler for successful Razorpay payment attempt
        async function paymentVerificationHandler(response) {
            console.log("Razorpay handler response:", response);
            paymentStatusMessage.textContent = 'Verifying payment... Please wait.';
            paymentSpinner.classList.remove('hidden');
            cancelPaymentButton.classList.add('hidden');

            const verifyFormData = new FormData(form);
            verifyFormData.append('action', 'verify_payment');
            verifyFormData.append('razorpay_payment_id', response.razorpay_payment_id);
            verifyFormData.append('razorpay_order_id', response.razorpay_order_id);
            verifyFormData.append('razorpay_signature', response.razorpay_signature);
            const photoInput = document.getElementById('passport_photo');
            if (photoInput.files.length > 0) { verifyFormData.append('passport_photo_filename', photoInput.files[0].name); }
            else { verifyFormData.append('passport_photo_filename', 'N/A'); }

            try {
                const verifyResponse = await fetch(BACKEND_URL, { method: 'POST', body: verifyFormData });

                if (!verifyResponse.ok) {
                     let errorText = `Verification request failed! Status: ${verifyResponse.status}`;
                     try { const errorData = await verifyResponse.json(); errorText = errorData.message || JSON.stringify(errorData); } catch (e) { try { errorText = await verifyResponse.text(); } catch (e) {} }
                     throw new Error(errorText);
                }

                const contentType = verifyResponse.headers.get("content-type");
                 if (!contentType || !contentType.includes("application/json")) {
                    const responseText = await verifyResponse.text();
                    console.error("Received non-JSON verification response:", responseText);
                    throw new Error(`Received non-JSON response from server during verification. Response: ${responseText.substring(0, 200)}...`);
                }

                const verifyResult = await verifyResponse.json();

                if (verifyResult.success) {
                    console.log("Verification successful:", verifyResult);
                    successPaymentId.textContent = response.razorpay_payment_id;
                    successOrderId.textContent = response.razorpay_order_id;
                    goToStep(4);
                } else {
                    throw new Error(verifyResult.message || "Payment verification failed by the server.");
                }
            } catch (verifyError) {
                console.error("Error verifying payment:", verifyError);
                failureReason.textContent = verifyError.message || "An error occurred during payment verification. Contact support if amount was deducted.";
                goToStep(5);
            } finally {
                 submitAndPayButton.disabled = false;
                 submitAndPayButton.innerHTML = 'Submit & Proceed to Pay ₹100';
                 submitAndPayButton.classList.remove('opacity-75', 'cursor-wait');
            }
        }

        // Handler for Razorpay modal dismissal
        function handleRazorpayDismiss() {
             console.log('Razorpay checkout modal closed by user.');
             paymentStatusMessage.textContent = 'Payment Cancelled / Incomplete';
             paymentErrorMessage.textContent = 'You closed or cancelled the payment process. Please try again if you wish to register.';
             paymentErrorMessage.classList.remove('hidden');
             paymentSpinner.classList.add('hidden');
             cancelPaymentButton.textContent = 'Edit Form Details';
             cancelPaymentButton.classList.remove('hidden');
             submitAndPayButton.disabled = false;
             submitAndPayButton.innerHTML = 'Submit & Proceed to Pay ₹100';
             submitAndPayButton.classList.remove('opacity-75', 'cursor-wait');
        }

        // Handler for Razorpay payment failure event
        function handleRazorpayFailure(response) {
            console.error("Razorpay payment.failed event:", response);
            let message = 'Payment Failed.';
            if (response.error) {
                message += ` Reason: ${response.error.description || 'Unknown Error'}.`;
                if (response.error.code) message += ` (Code: ${response.error.code})`;
                if (response.error.metadata) {
                     if(response.error.metadata.order_id) message += ` Order ID: ${response.error.metadata.order_id}.`;
                     if(response.error.metadata.payment_id) message += ` Payment ID: ${response.error.metadata.payment_id}.`;
                }
            }
            message += ' Please contact support if amount was deducted.';
            failureReason.textContent = message;
            goToStep(5);
             submitAndPayButton.disabled = false;
             submitAndPayButton.innerHTML = 'Submit & Proceed to Pay ₹100';
             submitAndPayButton.classList.remove('opacity-75', 'cursor-wait');
        }

         // Function to set max date for DOB input (cannot be today)
         function setMaxDobDate() {
            const today = new Date();
            today.setDate(today.getDate() - 1); // Set max date to yesterday
            const maxDate = today.toISOString().split('T')[0]; // Format as YYYY-MM-DD
            dobInput.setAttribute("max", maxDate);
         }

        // --- Event Listeners ---
        nextButtonStep1.addEventListener('click', () => { if (registrationOpen) goToStep(2); });
        prevButtonStep2.addEventListener('click', () => goToStep(1));
        submitAndPayButton.addEventListener('click', () => { if (registrationOpen) initiatePayment(); else alert("Registration is closed."); });
        cancelPaymentButton.addEventListener('click', () => goToStep(2));
        retryButton.addEventListener('click', () => { razorpayOrderId = null; goToStep(1); });

        // Real-time validation
        inputs.forEach(input => {
            input.addEventListener('input', () => validateInput(input));
            input.addEventListener('blur', () => validateInput(input));
            if (input.type === 'file' || input.tagName === 'SELECT') {
                input.addEventListener('change', () => validateInput(input));
            }
        });

        // --- Initialization ---
        setMaxDobDate();
        checkRegistrationDeadline();
        goToStep(1);

    </script>
</body>
</html>
